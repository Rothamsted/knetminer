var GENEMAP;(GENEMAP=GENEMAP||{}).AnnotationXMLReader=function(){var t=function(t,e){var n=t.getElementsByTagName(e);return n&&n.length>0?n[0].childNodes[0].nodeValue:null},e=function(e){for(var n,o,a,i,r={features:[]},l=e.getElementsByTagName("feature"),s=0;s<l.length;s++)r.features.push((n=l[s],o=void 0,a=void 0,i=void 0,o=+n.getElementsByTagName("start")[0].childNodes[0].nodeValue,a=+n.getElementsByTagName("end")[0].childNodes[0].nodeValue,i=(a-o)/2+o,{id:n.getAttribute("id"),chromosome:n.getElementsByTagName("chromosome")[0].childNodes[0].nodeValue,start:o,end:a,midpoint:i,type:t(n,"type"),color:t(n,"color"),label:t(n,"label"),link:t(n,"link"),score:t(n,"score"),pvalue:t(n,"pvalue"),trait:t(n,"trait"),selected:!1}));return r};return{readAnnotationXML:function(t){return log.info("reading annotation file: ",t),d3.promise.xml(t).then(e)},readAnnotationXMLFromRawXML:function(t){return log.info("reading annotation xml"),new Promise((function(e,n){e((new DOMParser).parseFromString(t,"application/xml"))})).then(e)}}},(GENEMAP=GENEMAP||{}).AutoLayoutDecorator=function(t){if(!(this instanceof arguments.callee))return new arguments.callee(t);var e={width:900,height:600,numberPerRow:7,margin:{top:.1,left:.1,bottom:.1,right:.1},cellMargin:{top:.05,left:.05,bottom:.1,right:.05},labelHeight:.02,chromosomeAspectRatio:.04,scale:1,annotations:{label:{size:3,show:!0,showThreshold:8,maxSize:14},marker:{size:6,show:!0,maxSize:20}}},n=_.merge({},e,t),o=function(t,e){var o=_.cloneDeep(t);if(t.show){var a=t.size*n.scale;e.showThreshold&&(o.show=a>=e.showThreshold),e.maxSize&&a>e.maxSize&&(o.size=e.maxSize/n.scale)}return o};return{decorateGenome:function(t){var e=t,a=n.width*(1-n.margin.left-n.margin.right),i=n.height*(1-n.margin.top-n.margin.bottom),r=Math.min(n.numberPerRow,e.chromosomes.length),l=Math.ceil(e.chromosomes.length/r);log.trace("numberPerRow= "+n.numberPerRow+", chromosomes.length= "+e.chromosomes.length),log.trace("Cols= "+r+", rows= "+l);var s={width:a/r,height:i/l},c={top:s.height*n.cellMargin.top,bottom:s.height*n.cellMargin.bottom,left:s.width*n.cellMargin.left,right:s.width*n.cellMargin.right},u=n.labelHeight*s.height,d=n.labelHeight*s.height,h=s.height-u-d-c.top-c.bottom,p=Math.min(65/n.scale,h*n.chromosomeAspectRatio),m=(s.width-p-c.left-c.right)/2,f=Math.max.apply(null,e.chromosomes.map((function(t){return t.length}))),g={label:_.pick(n.annotations.label,["size","show"]),marker:_.pick(n.annotations.marker,["size","show"])};g.label=o(g.label,n.annotations.label),g.marker=o(g.marker,n.annotations.marker);var y={chromosomePosition:{height:h,width:p,x:c.left+m,y:c.top+u},labelPosition:{height:u,width:s.width-c.left-c.right,chromosomeWidth:p,x:c.left,y:c.top},sizeLabelPosition:{cellHeight:h,height:d,width:s.width-c.left-c.right,x:c.left,y:c.top+u},qtlAnnotationPosition:{height:h,width:m,chromosomeWidth:p,x:c.left,y:c.top+u},geneAnnotationPosition:{height:h,width:m,x:c.left+m+p,y:c.top+u},longestChromosome:f,annotations:g,scale:n.scale};return 1==e.chromosomes.length&&(y.chromosomePosition.x=c.left+.5*m,y.geneAnnotationPosition.x=c.left+.5*m+p,y.qtlAnnotationPosition.width=.5*m,y.geneAnnotationPosition.width=1.5*m,y.labelPosition.x=c.left+.5*m,y.labelPosition.width=p,y.sizeLabelPosition.x=c.left+.5*m,y.sizeLabelPosition.width=p),e.drawing=_.pick(n,["width","height"]),e.drawing.margin={top:n.margin.top*e.drawing.height,left:n.margin.left*e.drawing.width,bottom:n.margin.bottom*e.drawing.height,right:n.margin.right*e.drawing.width},e.chromosomes.forEach((function(t,e){var o=e%n.numberPerRow,a=Math.floor(e/n.numberPerRow);t.cell={y:a*s.height+n.margin.top*n.height,x:o*s.width+n.margin.left*n.width,width:s.width,height:s.height}})),e.cellLayout=y,e},width:function(t){return arguments.length?(n.width=t,this):n.width},height:function(t){return arguments.length?(n.height=t,this):n.height},numberPerRow:function(t){return arguments.length?(n.numberPerRow=t,this):n.numberPerRow},margin:function(t){return arguments.length?(n.margin=_.merge(n.margin,t),this):n.margin},labelHeight:function(t){return arguments.length?(n.labelHeight=t,this):n.labelHeight},cellMargin:function(t){return arguments.length?(n.cellMargin=t,this):n.cellMargin},chromosomeAspectRatio:function(t){return arguments.length?(n.chromosomeAspectRatio=t,this):n.chromosomeAspectRatio},scale:function(t){return arguments.length?(n.scale=t,this):n.scale}}},(GENEMAP=GENEMAP||{}).BasemapXmlReader=function(){var t=function(t){return{index:t.getAttribute("index"),start:t.getElementsByTagName("start")[0].childNodes[0].nodeValue,end:t.getElementsByTagName("end")[0].childNodes[0].nodeValue,color:t.getElementsByTagName("color")[0].childNodes[0].nodeValue}},e=function(e){for(var n={index:e.getAttribute("index"),length:e.getAttribute("length"),number:e.getAttribute("number"),bands:[]},o=e.getElementsByTagName("band"),a=0;a<o.length;a++){var i=t(o[a]);n.bands.push(i)}return n},n=function(t){for(var n={chromosomes:[]},o=t.getElementsByTagName("chromosome"),a=0;a<o.length;a++){var i=e(o[a]);n.chromosomes.push(i)}return n};return{readBasemapXML:function(t){return log.info("reading basemap file: ",t),d3.promise.xml(t).then(n)},readBasemapXMLFromRawXML:function(t){return log.info("reading basemap xml"),new Promise((function(e,n){e((new DOMParser).parseFromString(t,"application/xml"))})).then(n)}}},function(t){var e=function(e,n){this.options=n,this.$body=t(document.body),this.$navbar=t(".navbar.navbar-fixed-top"),this.$element=t(e).delegate('[data-dismiss="modal-popup"]',"click.dismiss.modal-popup",t.proxy(this.hide,this)),this.$dialog=this.$element.find(".modal-dialog"),this.options.remote&&this.$element.find(".popover-content").load(this.options.remote),this.$parent=n.$parent};e.prototype=t.extend({},t.fn.modal.Constructor.prototype,{constructor:e,getDimensions:function(t){var e,n;if("offsetWidth"in t[0]&&t[0].offsetWidth)log.trace("Using offsetWidth"),e=t[0].offsetWidth,n=t[0].offsetHeight;else if("getBBox"in t[0]){log.trace("Using getBBox");var o=t[0].getBBox(),a=t[0].getScreenCTM();e=o.width*a.a,n=o.height*a.d}return{width:e,height:n}},show:function(){for(var e=0;e<2;e++){var n=this.$element;n.css({top:0,left:0,display:"block","z-index":1050});var o,a=n[0].offsetWidth,i=n[0].offsetHeight,r=this.$parent,l={my:"left top",at:"left top",of:r,collision:"none",using:function(t,e){o=t}};n.position(l);var s=this.getDimensions(t(r));o=_.merge({},o,s);var c="function"==typeof this.options.placement?this.options.placement.call(this,$tip[0],this.$element[0]):this.options.placement,u=null,d=null;if(this.options.boundingSize){var h={my:"left center",at:"right center",of:this.options.boundingSize[0],collision:"none",using:function(t,e){u=t}};n.position(h);var p={my:"right center",at:"left center",of:this.options.boundingSize[0],collision:"none",using:function(t,e){d=t}};n.position(p)}var m,f=10;switch(c){case"bottom":m={top:o.top+o.height,left:o.left+o.width/2-a/2};break;case"top":m={top:o.top-i,left:o.left+o.width/2-a/2};break;case"left":var g=o.left-a;d&&(g=Math.max(g,d.left)-f),m={top:o.top+o.height/2-i/2,left:g};break;case"right":g=o.left+o.width;u&&(g=Math.min(g,u.left)+f),m={top:o.top+o.height/2-i/2,left:g}}n.css(m).addClass(c).addClass("in"),n.toggleClass("force-redraw"),t.fn.modal.Constructor.prototype.show.call(this,arguments)}},backdrop:function(e){var n=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var o=t.support.transition&&n;this.$backdrop=t('<div class="modal-backdrop '+n+'" style="background:none" />').appendTo(document.body),"static"!=this.options.backdrop&&this.$backdrop.click(t.proxy(this.hide,this)),o&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),o?this.$backdrop.one(t.support.transition.end,e):e(),this.bodyIsOverflowing&&this.$navbar.css({paddingRight:this.scrollbarWidth})}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),t.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(t.support.transition.end,t.proxy(this.removeBackdrop,this)):this.removeBackdrop(),this.$body.removeClass("modal-open"),this.$navbar.css({paddingRight:0}),this.$body.css({paddingRight:0})):e&&e()}}),t.fn.modalPopover=function(n){return this.each((function(){var o=t(this),a="string"==typeof n?o.data("modal-popover"):void 0,i=t.extend({},t.fn.modalPopover.defaults,o.data(),"object"==typeof n&&n);i.$parent=i.$parent||a&&a.$parent||t(i.target),a||o.data("modal-popover",a=new e(this,i)),"string"==typeof n&&a[n]()}))},t.fn.modalPopover.Constructor=e,t.fn.modalPopover.defaults=t.extend({},t.fn.modal.defaults,{placement:"right",modalPosition:"body",keyboard:!0,backdrop:!0}),t((function(){t("body").on("click.modal-popover.data-api",'[data-toggle="modal-popover"]',(function(e){var n=t(this),o=n.attr("href"),a=t(n.attr("data-target")||o&&o.replace(/.*(?=#[^\s]+$)/,"")),i=a.data("modal-popover")?"toggle":t.extend({remote:!/#/.test(o)&&o},a.data(),n.data());i.$parent=n,e.preventDefault(),a.modalPopover(i).modalPopover("show").one("hide",(function(){n.focus()}))}))}))}(window.jQuery),(GENEMAP=GENEMAP||{}).Chromosome=function(t){var e={border:!1,longestChromosome:100,bands:"basemap",layout:{width:10,height:100,x:0,y:0},scale:1,onAnnotationSelectFunction:$.noop(),drawing:null},n=_.merge({},e,t),o=function(){return d3.scale.linear().range([0,n.layout.height]).domain([0,n.longestChromosome])},a=function(t){var e=o(),a=e(t.length),r=d3.select(this);r.attr({id:"chromosome_"+t.number,transform:"translate("+n.layout.x+","+n.layout.y+")"}),r.select("defs").html("").append("mask").attr({id:"chromosome_mask_"+t.number}).append("rect").attr({class:"mask_rect"}),r.select("#chromosome_mask_"+t.number).attr({width:n.layout.width,height:a});var s={width:n.layout.width,height:a,rx:Math.min(.25*n.layout.width,.01*n.layout.height),ry:Math.min(.25*n.layout.width,.01*n.layout.height)};r.select(".mask_rect").attr(s),r.select("rect.background").attr(s),r.select("rect.outline").attr(s);var c=[],u=function(){var t=r.selectAll("rect.selection").data(c);t.enter().append("rect").attr("class","selection").style({fill:"gray",opacity:.2}),t.attr({x:0,y:function(t){return Math.min(t.start,t.end)},width:n.layout.width,height:function(t){return Math.abs(t.end-t.start)}}),t.exit().remove()},d=d3.behavior.drag().on("dragstart",(function(t){var e=d3.mouse(this);c.push({start:e[1],end:e[1]}),u(),d3.event.sourceEvent.stopPropagation()})).on("drag",(function(t){c[0].end=d3.event.y,u(),d3.event.sourceEvent.stopPropagation(),d3.event.sourceEvent.preventDefault()})).on("dragend",(function(o){d3.event.sourceEvent.stopPropagation();var a=e.invert(c[0].start),i=e.invert(c[0].end);if(a>i){var r=a;a=i,i=r}t.layout.geneBandNodes.filter((function(t){return t.data.midpoint>a&&t.data.midpoint<i})).forEach((function(t){"gene"==t.data.type?t.data.visible=!0:"geneslist"==t.data.type&&t.data.genesList.forEach((function(t){t.visible=!0}))})),n.onAnnotationSelectFunction(),c=[],u()}));r.select("rect.background").call(d),n.border&&r.select("rect.border").attr({width:n.layout.width,height:n.layout.height});var h,p=r.select(".bands_container");"basemap"==n.bands?h=i:"genes"==n.bands&&(h=l),h(p,t),r.select(".bands_container").style({mask:"url(#chromosome_mask_"+t.number+")"})},i=function(t,e){var a=o(),i=t.selectAll("rect.band"),l=i.data(e.bands),s=i.data(e.layout.geneBandNodes);l.enter().append("rect").attr("class","band"),s.enter().append("rect").attr("id",(function(t){return t.data.id})),s.enter().append("rect").attr("class","band geneline infobox"),s.each((function(t){attribs=r(a,t),d3.select(this).attr(attribs)})),l.attr({width:n.layout.width,y:function(t){return a(t.start)},height:function(t){return a(t.end-t.start)},fill:function(t){return t.color}}),s.classed("selected",(function(t){return t.data.selected})),s.on("click",(function(t){"gene"==t.data.type&&(log.info("gene annotation click"),!t.data.displayed||t.data.visible||t.data.hidden?t.data.visible=!t.data.visible:(t.data.visible=!1,t.data.hidden=!0),n.onAnnotationSelectFunction()),"geneslist"==t.data.type&&(log.info("geneslist annotation click"),clusterCurrentlyHidden=t.data.genesList.some((function(t){return!t.displayed})),t.data.genesList.forEach((function(t){t.visible=clusterCurrentlyHidden,t.hidden=!clusterCurrentlyHidden})),n.onAnnotationSelectFunction())})),l.exit().remove()},r=function(t,e){var o,a=t(e.end-e.start);return a*n.scale>2?o={y:t(e.start),height:a}:(height=Math.min(2/n.scale,2),o={y:t(e.midpoint)-height/2,height:height}),o.fill=e.color,o.width=n.layout.width,o["fill-opacity"]=.8,o["stroke-dasharray"]=[0,n.layout.width,o.height,n.layout.width+o.height],o["stroke-width"]=n.layout.width/5,o},l=function(t,e){var a=o(),i=t.selectAll("rect.band").data(e.layout.geneBandNodes);i.enter().append("rect").attr({id:function(t){return t.data.id},class:"band geneline infobox"}),i.each((function(t){attribs=r(a,t),d3.select(this).attr(attribs)})),i.classed("selected",(function(t){return t.data.selected})),i.on("click",(function(t){"gene"==t.data.type&&(log.info("gene annotation click"),!t.data.displayed||t.data.visible||t.data.hidden?t.data.visible=!t.data.visible:(t.data.visible=!1,t.data.hidden=!0),n.onAnnotationSelectFunction()),"geneslist"==t.data.type&&(log.info("geneslist annotation click"),clusterCurrentlyHidden=t.data.genesList.some((function(t){return!t.displayed})),t.data.genesList.forEach((function(t){t.visible=clusterCurrentlyHidden,t.hidden=!clusterCurrentlyHidden})),n.onAnnotationSelectFunction())})),i.exit().remove()};function s(t){t.each((function(t){var e=d3.select(this).selectAll(".chromosome").data([t]),o=e.enter().append("g").attr("class","chromosome");o.append("defs"),o.append("rect").classed("background",!0),o.append("g").classed("bands_container",!0),o.append("rect").classed("outline",!0),n.border&&o.append("rect").classed("border",!0),e.each(a),e.exit().remove()}))}return s.onAnnotationSelectFunction=function(t){return arguments.length?(n.onAnnotationSelectFunction=t,s):n.onAnnotationSelectFunction},s.layout=function(t){return arguments.length?(n.layout=t,s):n.layout},s.drawing=function(t){return arguments.length?(n.drawing=t,s):n.drawing},s.longestChromosome=function(t){return arguments.length?(n.longestChromosome=t,s):n.longestChromosome},s.bands=function(t){return arguments.length?(n.bands=t,s):n.bands},s.scale=function(t){return arguments.length?(n.scale=t,s):n.scale},s.infoBoxManager=function(t){return arguments.length?(n.infoBoxManager=t,s):n.infoBoxManager},s},(GENEMAP=GENEMAP||{}).ChromosomeCell=function(t){var e={border:!1,onAnnotationSelectFunction:$.noop(),onExpandClusterFunction:$.noop(),onLabelSelectFunction:$.noop(),maxAnnotationLayers:3,maxSnpPValue:1,svg:null},n=_.merge({},e,t);function o(t){t.each((function(t){var e=t.cellLayout,o=d3.select(this).selectAll(".chromosome-cell").data(t.chromosomes),a=o.enter().append("g").attr("class","chromosome-cell");n.border&&a.append("rect").classed("border",!0),o.attr({transform:function(t){return"translate("+t.cell.x+","+t.cell.y+")"}}),n.border&&o.select("rect").attr({x:0,y:0,width:function(t){return t.cell.width},height:function(t){return t.cell.height}});t.chromosomes.length;var i=GENEMAP.GeneAnnotations().onAnnotationSelectFunction(n.onAnnotationSelectFunction).onExpandClusterFunction(n.onExpandClusterFunction).layout(e.geneAnnotationPosition).longestChromosome(e.longestChromosome).chromosomeWidth(e.chromosomePosition.width).annotationLabelSize(e.annotations.label.size).annotationMarkerSize(e.annotations.marker.size).drawing(n.svg).scale(e.scale);o.call(i);var r=GENEMAP.Chromosome().layout(e.chromosomePosition).longestChromosome(e.longestChromosome).onAnnotationSelectFunction(n.onAnnotationSelectFunction).scale(e.scale).bands("basemap").drawing(n.svg);o.call(r);var l=GENEMAP.ChromosomeLabel().layout(e.labelPosition).sizeLayout(e.sizeLabelPosition).onLabelSelectFunction(n.onLabelSelectFunction).longestChromosome(e.longestChromosome).scale(e.scale);o.call(l);var s=GENEMAP.QtlAnnotations().onAnnotationSelectFunction(n.onAnnotationSelectFunction).layout(e.qtlAnnotationPosition).longestChromosome(e.longestChromosome).chromosomeWidth(e.chromosomePosition.width).annotationLabelSize(e.annotations.label.size).annotationMarkerSize(e.annotations.marker.size).showAnnotationLabels(e.annotations.label.show).maxSnpPValue(n.maxSnpPValue).drawing(n.svg).scale(e.scale);o.call(s),o.exit().remove()}))}return o.onAnnotationSelectFunction=function(t){return arguments.length?(n.onAnnotationSelectFunction=t,o):n.onAnnotationSelectFunction},o.onExpandClusterFunction=function(t){return arguments.length?(n.onExpandClusterFunction=t,o):n.onExpandClusterFunction},o.onLabelSelectFunction=function(t){return arguments.length?(n.onLabelSelectFunction=t,o):n.onLabelSelectFunction},o.infoBoxManager=function(t){return arguments.length?(n.infoBoxManager=t,o):n.infoBoxManager},o.maxAnnotationLayers=function(t){return arguments.length?(n.maxAnnotationLayers=t,o):n.maxAnnotationLayers},o.maxSnpPValue=function(t){return arguments.length?(n.maxSnpPValue=t,o):n.maxSnpPValue},o.svg=function(t){return arguments.length?(n.svg=t,o):n.svg},o},(GENEMAP=GENEMAP||{}).ChromosomeLabel=function(t){var e={border:!1,layout:{width:100,height:20,x:0,y:0},sizeLayout:{width:100,height:20,x:0,y:0},scale:1,onLabelSelectFunction:function(t){alert("Click"+t.number)},labelSize:10,longestChromosome:100},n=_.merge({},e,t);function o(t){t.each((function(t){var e=d3.select(this).selectAll(".chromosome-label").data([t]);(o=e.enter().append("g").attr("class","chromosome-label")).append("text"),n.border&&o.append("rect").classed("border",!0),e.attr({transform:"translate("+n.layout.x+","+n.layout.y+")"}),e.select("text").attr({x:.5*n.layout.width,y:.5*n.layout.height}).style({"font-size":Math.max(14/n.scale,1.2*n.layout.chromosomeWidth)+"px"}).text(t.number).on("click",n.onLabelSelectFunction),n.border&&e.select("rect").attr({width:n.layout.width,height:n.layout.height}),e.exit().remove();var o,a=d3.select(this).selectAll(".chromosome-size-label").data([t]);(o=a.enter().append("g").attr("class","chromosome-size-label")).append("text");var i,r=n.sizeLayout.y+n.sizeLayout.cellHeight*t.length/n.longestChromosome,l=1.2*n.labelSize/Math.min(5,n.scale)+"px";a.attr({transform:"translate("+n.sizeLayout.x+","+r+")"}),a.select("text").attr({x:.5*n.sizeLayout.width,y:0,dy:"1em"}).style({"font-size":l}).text((i=t.length)<1e3?i:i<1e6?(i/1e3).toFixed(1)+"Kb":(i/1e6).toFixed(1)+"Mb"),a.exit().remove()}))}return o.longestChromosome=function(t){return arguments.length?(n.longestChromosome=t,o):n.longestChromosome},o.layout=function(t){return arguments.length?(n.layout=t,o):n.layout},o.sizeLayout=function(t){return arguments.length?(n.sizeLayout=t,o):n.sizeLayout},o.scale=function(t){return arguments.length?(n.scale=t,o):n.scale},o.onLabelSelectFunction=function(t){return arguments.length?(n.onLabelSelectFunction=t,o):n.onLabelSelectFunction},o},(GENEMAP=GENEMAP||{}).GeneAnnotationLayout=function(t){var e=_.merge({},{longestChromosome:100,layout:{width:10,height:100,x:0,y:0},autoLabels:!0,manualLabels:!0,annotationMarkerSize:5,annotationLabelSize:5,doCluster:!0,nClusters:6,nGenesToDisplay:1e3,maxAnnotationLayers:3,displayedFontSize:13,scale:1},t),n=function(t,n,o,a,i){return par={},par.scale=t,par.availableHeight=i,par.lineSpacing=1,par.layerGap=n*(.1+.1/t),par.spaceForLabel=n-par.layerGap,par.setFontSize=Math.min(par.spaceForLabel/o*3.5,a/e.scale),par.nodeSpacing=par.setFontSize,par.nLabels=.4*i/(par.nodeSpacing+par.lineSpacing),par.density=1,par},o=function(t,e,n,o){o.forEach((function(t){t.displayed=!0,t.fontSize=n.setFontSize}));var a=o.map((function(t){return new labella.Node(e(t.midpoint),n.setFontSize,t)}));try{t.nodes(a).compute()}catch(t){if(t instanceof RangeError)return null;throw t}return a},a=function(t){allGenes=t.annotations.allGenes.filter((function(t){return t.globalIndex<e.nGenesToDisplay}));var a,i=e.layout.width,r=e.layout.height*Math.min(1,.2+t.length/e.longestChromosome),l=allGenes.reduce((function(t,e){return Math.max(t,e.label.length)}),0),s=1.1*e.displayedFontSize,c=.9*e.displayedFontSize,u=function(t,e,n,o){var a=e/3,i=a/n*4,r=i*t>o;return r?2:(r=(i=(a=e-e*(.1+.1/t))/n*4)*t>o)?1:0}(e.scale,i,l,s);2==u?a=function(t,n,o,a,i){var r={};return r.scale=t,r.availableHeight=i,r.lineSpacing=1,r.setFontSize=Math.min(n/3/o*3.5,a/e.scale),r.nodeSpacing=r.setFontSize,r.spaceForLabel=1.3*o*r.setFontSize/3.5,r.layerGap=Math.min(5*r.setFontSize,n/3),r.density=.9,r.nLabels=.6*i/(r.nodeSpacing+r.lineSpacing),r}(e.scale,i,l,c,r):1==u?a=n(e.scale,i,l,c,r):0==u&&((a=n(e.scale,i,l,c,r)).nLabels=0);var d=d3.scale.linear().range([0,e.layout.height]).domain([0,e.longestChromosome]);forceConfig={nodeSpacing:a.nodeSpacing,lineSpacing:a.lineSpacing,algorithm:"overlap",minPos:0,maxPos:a.availableHeight,density:a.density};var h=new labella.Force(forceConfig);allGenes.forEach((function(t){t.displayed=!1}));var p=e.manualLabels?new Set(allGenes.filter((function(t){return t.visible}))):new Set;e.autoLabels&&allGenes.slice(0,a.nLabels).filter((function(t){return!t.hidden})).forEach((function(t){p.add(t)}));var m,f=Array.from(p),g=o(h,d,a,f);if(g||(h.options({algorithm:"simple"}),g=o(h,d,a,f)),g){var y=g.map((function(t){return t.getLayerIndex()}));m=Math.max.apply(null,y)}if(!g||m>3){log.trace("Too many lables to display - clustering instead");var b=GENEMAP.GeneClusterer().nClusters(Math.max(a.nLabels,1));try{var v=b.createClustersFromGenes(f)}catch(t){log.info(f),v=[]}g=o(h,d,a,v)}renderConfig={direction:"right",layerGap:a.layerGap,nodeHeight:a.spaceForLabel};var x=new labella.Renderer(renderConfig);return x.layout(g),g.forEach((function(t){t.data.path=x.generatePath(t)})),g};return my={},my.layoutChromosome=function(t){t.layout.annotationNodes=a(t)||t.layout.annotationNodes},my.computeChromosomeClusters=function(t){t.layout.annotationClusters=function(t){var e=GENEMAP.GeneClusterer(),n=t.annotations.genes;return e.createClustersFromGenes(n)}(t),t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice()},my.expandAllChromosomeClusters=function(t){t.layout.annotationDisplayClusters=t.annotations.genes},my.collapseAllChromosomeClusters=function(t){t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice()},my.expandAChromosomeCluster=function(t,e){t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice(),e.genesList.forEach((function(e){t.layout.annotationDisplayClusters.push(e)}));var n=t.layout.annotationDisplayClusters.indexOf(e);t.layout.annotationDisplayClusters.splice(n,1)},my.computeNormalisedGeneScores=function(t){var e=t.reduce((function(t,e){return t.concat(e.annotations.genes.filter((function(t){return t.displayed})))}),[]);if(e.every((function(t){return t.score}))){var n=e.reduce((function(t,e){return Math.max(t,e.score)}),0),o=e.reduce((function(t,e){return Math.min(t,e.score)}),0);e.forEach((function(t){t.normedScore=.5*(t.score-o)/(n-o)+.5}))}else e.forEach((function(t){t.normedScore=null}))},my},(GENEMAP=GENEMAP||{}).GeneAnnotationPopup=function(t){var e={onAnnotationSelectFunction:$.noop(),drawing:null,popoverId:""},n=_.merge({},e,t),o={show:function(t){t.visible=!0},hide:function(t){t.visible=!1,t.hidden=!0},auto:function(t){t.visible=!1,t.hidden=!1}},a=function(t,e){t.select("span.genelabel").text((function(t){return t.label})).style("font-weight",(function(t){return t.selected?"bold":"normal"})).style("opacity",(function(t){return t.visible||t.selected?1:t.normedScore?t.normedScore:t.importance})).style("color",(function(t){return e.visible||e.selected?e.color:null}));var n=t.select("div.btn-group");footerLinks=n.selectAll("a").data(["show","hide","auto"]),footerLinks.classed("disabled",(function(t){return"show"==t&&e.visible||"hide"==t&&e.hidden&&!e.visible||"auto"==t&&!e.hidden&&!e.visible}))},i={};return i.geneAnnotationsPopoverFunction=function(t){var e="geneslist"==t.data.type;log.trace("Gene Annotation Context Menu"),d3.select(n.popoverId).attr("class","popover"),popoverTitle=d3.select(n.popoverId).select(".popover-title"),popoverContent=d3.select(n.popoverId).select(".popover-content"),popoverTitle.selectAll("*").remove(),popoverTitle.text(""),popoverContent.selectAll("*").remove(),popoverContent.text(""),e?function(t,e,i){var r=i.data.genesList,l=e.selectAll("p").data(r);t.append("span").text("Cluster"),links=t.append("div.btn-group").selectAll("a").data(["show","hide","auto"]),links.enter().append("a").attr("href","#").text((function(t){return t})).classed("btn btn-small",!0).on("click",(function(t){var e=o[t];r.forEach(e),l.each((function(t){var e=d3.select(this);a(e,t)})),d3.event.preventDefault(),n.onAnnotationSelectFunction()}));var s=l.enter().append("p");s.append("span").classed("genelabel",!0),s.append("div").classed("btn-group",!0),l.each((function(t){var e=d3.select(this),i=e.select("div.btn-group");footerLinks=i.selectAll("a").data(["show","hide","auto"]),footerLinks.enter().append("a").attr("href","#").text((function(t){return t})).classed("btn btn-small",!0).on("click",(function(i){(0,o[i])(t),n.onAnnotationSelectFunction(),d3.event.preventDefault(),a(e,t)}))})),l.each((function(t){var e=d3.select(this);a(e,t)}))}(popoverTitle,popoverContent,t):function(t,e,a){var i=a.data;t.append("a").attr({href:i.link}).text(i.label),e.append("p").text("Chromosome "+i.chromosome+": "+i.start+"-"+i.end),i.score&&e.append("p").text("Score: "+parseFloat(i.score).toFixed(3)),e.append("hr");var r=e.append("p").style("float","right"),l=function(){footerLinks=r.selectAll("a").data(["show","hide","auto"]),footerLinks.enter().append("a").attr("href","#").text((function(t){return t})).classed("btn btn-small",!0).on("click",(function(t){(0,o[t])(i),n.onAnnotationSelectFunction(),d3.event.preventDefault(),l()})),footerLinks.classed("disabled",(function(t){return"show"==t&&i.visible||"hide"==t&&i.hidden&&!i.visible||"auto"==t&&!i.hidden&&!i.visible}))};l()}(popoverTitle,popoverContent,t);var i=d3.select(this).select("text");$(n.popoverId).modalPopover({target:$(i[0]),parent:$(i[0]),"modal-position":"relative",placement:"right",boundingSize:n.drawing}),$(n.popoverId).modalPopover("show"),$(n.popoverId).on("mousedown mousewheel",(function(t){log.trace("popover click"),t.stopPropagation()}))},i},(GENEMAP=GENEMAP||{}).GeneAnnotations=function(t){var e={border:!1,labelRectangles:!1,onAnnotationSelectFunction:$.noop(),onExpandClusterFunction:$.noop(),longestChromosome:100,layout:{width:10,height:100,x:0,y:0},chromosomeWidth:20,annotationMarkerSize:5,annotationLabelSize:5,scale:null,drawing:null},n=_.merge({},e,t),o=null,a=function(t,e){_.pick(n,["onAnnotationSelectFunction","drawing"]);n.popoverId="#clusterPopover",o=GENEMAP.GeneAnnotationPopup(n),log.trace("setupGeneAnnotations");var a=d3.scale.linear().range([0,n.layout.height]).domain([0,n.longestChromosome]),i=t.selectAll("g.gene-annotation").data(e.layout.annotationNodes,(function(t){return t.data.id})),r=i.enter().append("g").classed("gene-annotation",!0);r.append("line").classed("midpoint-line",!0),r.append("path").classed("link",!0).attr({d:function(t){return t.data.path}}),n.labelRectangles&&r.append("rect").classed("labella",!0),r.append("text").attr({x:function(t){return t.x+.1*n.annotationLabelSize},y:function(t){return t.y+.4*n.annotationLabelSize}}),i.attr("id",(function(t){return"feature_"+t.data.id})),i.classed("selected",(function(t){return t.data.selected})),i.select("line.midpoint-line").attr({x1:-.5*n.chromosomeWidth,y1:function(t){return a(t.data.midpoint)},y2:function(t){return a(t.data.midpoint)},x2:0}),i.select("text").text((function(t){return"gene"==t.data.type?t.data.label:"geneslist"==t.data.type?"("+t.data.genesList.length+")":void 0})),n.labelRectangles&&i.select("rect.labella").attr({fill:"pink",stroke:"none",x:function(t){return t.x},y:function(t){return t.y-t.dy/2},width:function(t){return t.dx},height:function(t){return t.dy}});var l="0.5";GENEMAP.vectorEffectSupport||(l=.5/n.scale),i.select("path.link").style("opacity",(function(t){return t.data.visible||t.data.selected?1:t.data.normedScore?t.data.normedScore:t.data.importance})).style("stroke-width",(function(t){return l})).style("stroke",(function(t){return t.data.visible||t.data.selected?t.data.color:"gray"})),i.select("text").style("font-size",(function(t){return(t.data.selected?.2:0)+t.data.fontSize+"px"})).style("font-weight",(function(t){return t.data.selected?"bold":"normal"})).style("opacity",(function(t){return t.data.visible||t.data.selected?1:t.data.normedScore?t.data.normedScore:t.data.importance})).style("fill",(function(t){return t.data.visible||t.data.selected?t.data.color:null})),i.select("text").transition().duration(300).attr({x:function(t){return t.x+.1*n.annotationLabelSize},y:function(t){return t.y+.4*n.annotationLabelSize}}),i.select("path.link").transition().duration(300).attr({d:function(t){return t.data.path}}),i.on("click",(function(t){"gene"==t.data.type&&(log.info("gene annotation click"),t.data.selected=!t.data.selected,t.data.selected&&(t.data.visible=!0),n.onAnnotationSelectFunction()),"geneslist"==t.data.type&&(log.trace("geneslist annotation click"),n.onExpandClusterFunction(e,t.data))})),i.on("contextmenu",o.geneAnnotationsPopoverFunction),i.exit().remove()};function i(t){t.each((function(t){var e,o=d3.select(this).selectAll(".gene-annotations").data([t]);o.enter().append("g").attr("class","gene-annotations"),o.attr({transform:"translate("+n.layout.x+","+n.layout.y+")",id:function(t){return"annotation_"+t.number}}),a(o,t),n.border&&((e=o).select("rect.border").empty()&&e.append("rect").classed("border",!0),e.select("rect.border").attr({width:n.layout.width,height:n.layout.height})),o.exit().remove()}))}return i.onAnnotationSelectFunction=function(t){return arguments.length?(n.onAnnotationSelectFunction=t,i):n.onAnnotationSelectFunction},i.onExpandClusterFunction=function(t){return arguments.length?(n.onExpandClusterFunction=t,i):n.onExpandClusterFunction},i.layout=function(t){return arguments.length?(n.layout=t,i):n.layout},i.drawing=function(t){return arguments.length?(n.drawing=t,i):n.drawing},i.scale=function(t){return arguments.length?(n.scale=t,i):n.scale},i.longestChromosome=function(t){return arguments.length?(n.longestChromosome=t,i):n.longestChromosome},i.chromosomeWidth=function(t){return arguments.length?(n.chromosomeWidth=t,i):n.chromosomeWidth},i.annotationLabelSize=function(t){return arguments.length?(n.annotationLabelSize=t,i):n.annotationLabelSize},i.annotationMarkerSize=function(t){return arguments.length?(n.annotationMarkerSize=t,i):n.annotationMarkerSize},i},(GENEMAP=GENEMAP||{}).GeneBandsLayout=function(t){var e=_.merge({},{longestChromosome:100,layout:{width:10,height:100,x:0,y:0},doCluster:!0,nClusters:6,scale:1,nGenesToDisplay:1e3},t),n=function(t){if("gene"==t.type){var e=t;return result={start:e.start,end:e.end,midpoint:e.midpoint,color:e.color,data:e},result}if("geneslist"==t.type)return maxPosition=t.genesList.reduce((function(t,e){return Math.max(t,e.end)}),0),minPosition=t.genesList.reduce((function(t,e){return Math.min(t,e.start)}),1/0),result={start:minPosition,end:maxPosition,midpoint:t.midpoint,color:"#0000FF",data:t},result;log.error("unregconized cluster type"),log.info(t)},o=function(t){return d3.scale.linear().range([0,e.layout.height]).domain([0,e.longestChromosome]),t.layout.geneBandDisplayClusters.map(n)};return my={},my.layoutChromosome=function(t){t.layout.geneBandNodes=o(t)},my.computeChromosomeClusters=function(t){ly=t.layout,ly.geneBandClusters=function(t){var n=t.annotations.allGenes.filter((function(t){return t.globalIndex<e.nGenesToDisplay}));log.trace("nGenesToDisplay is "+e.nGenesToDisplay),log.trace("Laying out "+n.length+" genes."),n.sort((function(t,e){return t.midpoint-e.midpoint}));for(var o=[],a=0;a<n.length;){for(iDiff=a;iDiff<n.length&&n[a].midpoint==n[iDiff].midpoint;)iDiff++;if(nMatching=iDiff-a,1==nMatching)o.push(n[a]),a++;else{var i=n.slice(a,iDiff),r=i.reduce((function(t,e){return t+e.id.toString()}),""),l={genesList:i,midpoint:i[0].midpoint,type:"geneslist",id:r};o.push(l),a=iDiff}}return o.sort((function(t,e){return t.midpoint<e.midpoint})),o}(t),ly.geneBandDisplayClusters=ly.geneBandClusters.slice()},my.expandAllChromosomeClusters=function(t){ly=t.layout,ly.geneBandDisplayClusters=t.annotations.allGenes},my.collapseAllChromosomeClusters=function(t){ly=t.layout,ly.geneBandDisplayClusters=ly.geneBandClusters.slice()},my.expandAChromosomeCluster=function(t,e){ly=t.layout,ly.geneBandDisplayClusters=ly.geneBandClusters.slice(),e.genesList.forEach((function(t){ly.geneBandDisplayClusters.push(t)}));var n=ly.geneBandDisplayClusters.indexOf(e);ly.geneBandDisplayClusters.splice(n,1)},my},(GENEMAP=GENEMAP||{}).GeneClusterer=function(t){var e={},n=_.merge({},{nClusters:6},t);return e.createClustersFromGenes=function(t){var e=[];if(t.length<1)return e;var o=Math.min(n.nClusters,t.length),a=t.map((function(t){return t.midpoint}));clusterPointsList=ss.ckmeans(a,o);for(var i=[],r=0;r<clusterPointsList.length;r++)i.push([]);return t.map((function(t){iCluster=clusterPointsList.findIndex((function(e){return e.includes(t.midpoint)})),i[iCluster].push(t)})),i.map((function(t){if(t.length<2)e.push.apply(e,t);else{var n=t.reduce((function(t,e){return t+e.midpoint}),0)/t.length,o=t.reduce((function(t,e){return t+e.id.toString()}),""),a={genesList:t,midpoint:n,type:"geneslist",id:o.toString()};e.push(a)}})),e},e.nClusters=function(t){return arguments.length?(n.nClusters=t,e):n.nClusters},e},(GENEMAP=GENEMAP||{}).vectorEffectSupport=!0,GENEMAP.Listener=function(t){var e=t,n=[],o=function(t){return arguments.length?t==e?e:(e=t,void n.forEach((function(t){t(e)}))):e};return o.addListener=function(t){return n.push(t),o},o.removeListener=function(t){return _.pull(n,t),o},o},GENEMAP.GeneMap=function(t){var e,n,o,a,i,r,l,s,c,u,d,h,p,m,f,g,y=_.merge({},{apiUrl:"/",width:"800",height:"500",svgDefsFile:"./assets/sprite-defs.svg",layout:{margin:{top:.05,right:.05,bottom:.05,left:.05},numberPerRow:7,maxAnnotationLayers:3},pngScale:2,contentBorder:!1,initialMaxGenes:200,nGenesToDisplay:200,maxSnpPValue:1e-5,annotationLabelSize:13,extraPanArea:.4},t),b=!1,v={},x=function(){if(b){var t=$(e).height();y.height=t-80,y.width="100%"}},w=function(){d3.select(e);b?(y.height=v.height,y.width=v.width,d3.select(e).classed("fullscreen",!1),b=!1):(v.height=y.height,v.width=y.width,d3.select(e).classed("fullscreen",!0),b=!0),x(),z(),P(),H()},C=function(){var t={width:y.width,height:y.height};if(t.width.toString().indexOf("%")>=0||t.height.toString().indexOf("%")>=0){var n=d3.select(e).select("svg").node().getBoundingClientRect();t.width.toString().indexOf("%")>=0&&(t.width=n.width),t.height.toString().indexOf("%")>=0&&(t.height=n.height)}return t},L=function(){var t=!1;return r&&(t=0!==r.translate()[0]||0!==r.translate()[1]||t,t=1!==r.scale()||t),t},P=function(){1==r.scale()&&_.isEqual(r.translate(),[0,0])||(r.translate([0,0]),r.scale(1),o.attr("transform","translate("+r.translate()+")scale("+r.scale()+")"),h.setFitButtonEnabled(L()),I(),H())},k=function(){log.info("Exporting whole canvas to png, scale is "+r.scale()),o.attr("transform","translate(0,0)scale(1)"),saveSvgAsPng(o[0][0],"genemap.png",{scale:r.scale()*y.pngScale}),o.attr("transform","translate("+r.translate()+")scale("+r.scale()+")")},A=function(){log.info("Exporting view to png, scale is "+r.scale()),saveSvgAsPng(n[0][0],"genemap.png",{scale:y.pngScale})};l=function(){var t=d3.event.translate;if(c){var e=n.node().getBoundingClientRect(),i=-c.drawing.width*d3.event.scale+e.width*(1-y.extraPanArea)+c.drawing.margin.right*d3.event.scale,l=e.width*y.extraPanArea-c.drawing.margin.left*d3.event.scale;t[0]=_.clamp(t[0],i,l);var u=-c.drawing.height*d3.event.scale+e.height*(1-y.extraPanArea)+c.drawing.margin.bottom*d3.event.scale,d=e.height*y.extraPanArea-c.drawing.margin.top*d3.event.scale;t[1]=_.clamp(t[1],u,d)}r.translate(t),r.scale()!=s&&(log.trace("New zoom"),I(),H()),s=r.scale(),h.setFitButtonEnabled(L()),o.attr("transform","translate("+r.translate()+")scale("+d3.event.scale+")"),a.text("translate: [ "+r.translate()[0].toFixed(1)+","+r.translate()[1].toFixed(1)+"]  zoom:"+r.scale().toFixed(2))};var E=function(){log.trace("mouse down"),n.classed("dragging",!0)},S=function(){log.trace("mouse up"),n.classed("dragging",!1)},M=function(){log.trace("context click"),d3.event.preventDefault()},z=function(t){$("#clusterPopover").modalPopover("hide"),$(".genemap-advanced-menu").modalPopover("hide")},G=function(t){"auto"==t?(p=!0,m=!0,c.chromosomes.forEach((function(t){t.annotations.genes.forEach((function(t){1==t.selected&&(t.visible=!0)}))}))):"show"==t?(p=!1,m=!0):"hide"==t&&(p=!1,m=!1),c.chromosomes.forEach((function(e){e.annotations.genes.forEach((function(e){"auto"===t?delete e.showLabel:e.showLabel=t}))})),I(),H()},N=function(){var t=c.chromosomes.some((function(t){return t.annotations.genes.some((function(t){return t.selected}))}));I(),H(),d3.select(".network-btn").classed("disabled",!t)},B=function(t){d?(c=u,d=!1):(c={chromosomes:[t]},d=!0),P(),I(),H()},F=function(){var t=_.flatMap(c.chromosomes.map((function(t){return t.annotations.genes.filter((function(t){return t.selected})).map((function(t){var e=t.link,n=e.substring(e.indexOf("list="),e.length).split("=")[1];return decodeURIComponent(n.replace(/\+/g," "))}))}))),e=y.apiUrl+"/network";log.info("selected labels: "+t),generateCyJSNetwork(e,{list:t,keyword:$("#keywords").val()})},T=function(){var t,e=h.getTagButtonState();t="auto"===e?"show":"show"===e?"hide":"auto",h.setTabButtonState(t),G(t),H()},D=function(){log.info("Reset Labels"),c.chromosomes.forEach((function(t){t.annotations.allGenes.forEach((function(t){t.selected=!1,t.visible=!1,t.hidden=!1}))})),I(),H()},R=function(t){log.trace("Number per row:",t),y.layout.numberPerRow=t,V(),I(),H()},q=function(t){log.info("onToggleQTLDisplay"),"all"==t?(f=!0,g=!0):"selected"==t?(f=!1,g="true"):(f=!1,g=!1),W(),I(),H()},Q=function(){var t=GENEMAP.AutoLayoutDecorator(y.layout).width(C().width).height(C().height).scale(r.scale());c=t.decorateGenome(c)},V=function(){c.chromosomes.forEach((function(t){t.layout=t.layout||{},t.layout.annotationDisplayClusters=null,t.layout.geneBandDisplayClusters=null}))},W=function(){c.chromosomes.forEach((function(t){t.layout=t.layout||{},t.layout.qtlDisplayClusters=null}))},I=function(){Q();c.chromosomes.length;var t=GENEMAP.GeneAnnotationLayout({longestChromosome:c.cellLayout.longestChromosome,layout:c.cellLayout.geneAnnotationPosition,annotationMarkerSize:c.cellLayout.annotations.marker.size,annotationLabelSize:c.cellLayout.annotations.label.size,scale:r.scale(),autoLabels:p,manualLabels:m,nGenesToDisplay:y.nGenesToDisplay,displayedFontSize:y.annotationLabelSize}),e=GENEMAP.GeneBandsLayout({longestChromosome:c.cellLayout.longestChromosome,layout:c.cellLayout.geneAnnotationPosition,nClusters:50,scale:r.scale(),nGenesToDisplay:y.nGenesToDisplay}),n=GENEMAP.QTLAnnotationLayout({longestChromosome:c.cellLayout.longestChromosome,layout:c.cellLayout.qtlAnnotationPosition,scale:r.scale(),showAllQTLs:f,showSelectedQTLs:g,showAutoQTLLabels:f,showSelectedQTLLabels:g,annotationLabelSize:c.cellLayout.annotations.label.size});c.chromosomes.forEach((function(o){o.layout=o.layout||{},o.layout.annotationDisplayClusters||t.computeChromosomeClusters(o),t.layoutChromosome(o),o.layout.geneBandDisplayClusters||e.computeChromosomeClusters(o),e.layoutChromosome(o),o.layout.qtlDisplayClusters||n.computeChromosomeClusters(o),n.layoutChromosome(o)})),t.computeNormalisedGeneScores(c.chromosomes)},X=function(t){var n,o=t.append("svg").attr({width:y.width,height:y.height,class:"mapview"});a=t.append("div").append("span").attr({class:"logger",id:"logbar"}),i=t.append("div").attr({class:"key",id:"keybar"}),GENEMAP.vectorEffectSupport="vectorEffect"in o[0][0].style,n="mousedown mousewheel DOMMouseScroll touchstart ",$(e).off(n).on(n,(function(t){"undefined"!==t.target&&"a"===t.target.tagName.toLowerCase()||$(t.target).closest(".genemap-advanced-menu").length>0||z(t)})),$("body").on("click",(function(t){$(t.target).closest(e).length<1&&1==b&&w()})),o.on("mousedown",E).on("mouseup",S).on("contextmenu",M),o.append("g").classed("zoom_window",!0).append("rect").classed("drawing_outline",!0),y.contentBorder&&t.select(".zoom_window").append("rect").classed("drawing_margin",!0),s=1,(r=d3.behavior.zoom().scaleExtent([1,50])).on("zoom",l),t.select("svg").call(r);var c=t.append("div").attr({id:"clusterPopover",class:"popover"});return c.append("div").attr({class:"arrow"}),c.append("h3").attr({class:"popover-title"}).text("Cluster"),c.append("div").attr({class:"popover-content"}),o},H=function(){var t,i;d3.select(e).select("svg").node()?(n=d3.select(e).select("svg")).attr({width:y.width,height:y.height}):n=X(d3.select(e)),a.text("translate: [ "+r.translate()[0].toFixed(1)+","+r.translate()[1].toFixed(1)+"]  zoom:"+r.scale().toFixed(2)),Q(),c.chromosomes.every((function(t){return t.layout}))||I(),n.datum(c),(o=n.select(".zoom_window")).select(".drawing_outline").attr({width:c.drawing.width,height:c.drawing.height}),y.contentBorder&&(t=c.drawing,i=c.margin,o.select(".drawing_margin").attr({x:i.left,y:i.top,width:t.width-i.left-i.right,height:t.height-i.top-i.bottom}));var l=GENEMAP.ChromosomeCell().onAnnotationSelectFunction(N).onLabelSelectFunction(B).maxAnnotationLayers(y.layout.maxAnnotationLayers).maxSnpPValue(y.maxSnpPValue).svg(n);o.call(l)};function O(t){t.each((function(t){e=this,c=u=t,d=!1,h||(h=GENEMAP.MenuBar().onTagBtnClick(T).onFitBtnClick(P).onLabelBtnClick(G).onQtlBtnClick(q).onNetworkBtnClick(F).onResetBtnClick(D).onSetNumberPerRowClick(R).initialMaxGenes(y.nGenesToDisplay).initialNPerRow(y.layout.numberPerRow).onExportBtnClick(A).onExportAllBtnClick(k).onExpandBtnClick(w).maxSnpPValueProperty(O.maxSnpPValue).nGenesToDisplayProperty(O.nGenesToDisplay).annotationLabelSizeProperty(O.annotationLabelSize)),d3.select(e).call(h),h.setNetworkButtonEnabled(!1),h.setFitButtonEnabled(!1),h.setTabButtonState("auto"),H()}))}return O.resetZoom=P,O.width=function(t){return arguments.length?(y.width=t,O):y.width},O.height=function(t){return arguments.length?(y.height=t,O):y.height},O.layout=function(t){return arguments.length?(y.layout=_.merge(y.layout,t),O):y.layout},O.draw=function(t,e,n){GENEMAP.XmlDataReader().readXMLData(e,n).then((function(e){O._draw(t,e)}))},O.drawFromRawAnnotationXML=function(t,e,n){GENEMAP.XmlDataReader().readXMLDataFromRawAnnotationXML(e,n).then((function(e){O._draw(t,e)}))},O._draw=function(t,n){d3.select(t).selectAll("div").data(["genemap-target"]).enter().append("div").attr("id",(function(t){return t})),e=d3.select(t).select("#genemap-target")[0][0],log.info("drawing genome to target"),d3.select(e).datum(n).call(O),O.nGenesToDisplay(y.initialMaxGenes),P(),function(t,e){var n=new Set,o=[];e.chromosomes.forEach((function(t){t.annotations.snps.forEach((function(t){n.has(t.trait)||null!=t.trait&&o.push({trait:t.trait,color:t.color}),n.add(t.trait)}))})),o.length>0?t.text("SNP legend: "):t.text("");var a=t.selectAll("span").data(o),i=a.enter().append("span").classed("key-item",!0);i.append("span").style("background-color",(function(t){return t.color})).classed("colorbox",!0).append("svg"),i.append("span").text((function(t){return t.trait})),a.exit().remove()}(i,c)},O.redraw=function(t){e=d3.select(t).select("#genemap-target")[0][0],x(),d3.select(e).call(O),z()},O.setGeneLabels=function(t){e&&G(t)},O.maxSnpPValue=GENEMAP.Listener(y.maxSnpPValue).addListener((function(t){var e=Number(t);log.info("Setting max PValue for SNPs to",t,"(",e,")"),isNaN(e)&&(log.info("Can't parse max PValue"),O.maxSnpPValue(y.maxSnpPValue)),y.maxSnpPValue=Number(t),I(),H()})),O.nGenesToDisplay=GENEMAP.Listener(y.nGenesToDisplay).addListener((function(t){log.info("Setting nGenes to ",t);var e=y.nGenesToDisplay;y.nGenesToDisplay=t,t!=e&&(V(),I(),H())})),O.annotationLabelSize=GENEMAP.Listener(y.annotationLabelSize).addListener((function(t){log.info("Setting annotation label size to",t),y.annotationLabelSize=t,V(),I(),H()})),O.setQtlLabels=function(t){e&&d3.select(e).datum().chromosomes.forEach((function(e){e.annotations.qtls.forEach((function(e){"auto"===t?delete e.showLabel:e.showLabel=t}))}))},O.loggingOn=function(){a.style("display","initial")},O.loggingOff=function(){a.style("display","none")},O},function(t){var e=function(t,e,n){this.distance=t,this.linkage=e,this.threshold=null==n?1/0:n};e.prototype={cluster:function(t,e,n){this.clusters=[],this.dists=[],this.mins=[],this.index=[];for(var o=0;o<t.length;o++){var a={value:t[o],key:o,index:o,size:1};this.clusters[o]=a,this.index[o]=a,this.dists[o]=[],this.mins[o]=0}for(o=0;o<this.clusters.length;o++)for(var i=0;i<=o;i++){var r=o==i?1/0:this.distance(this.clusters[o].value,this.clusters[i].value);this.dists[o][i]=r,this.dists[i][o]=r,r<this.dists[o][this.mins[o]]&&(this.mins[o]=i)}var l=this.mergeClosest();for(o=0;l;)n&&o++%e==0&&n(this.clusters),l=this.mergeClosest();return this.clusters.forEach((function(t){delete t.key,delete t.index})),this.clusters},mergeClosest:function(){for(var t=0,e=1/0,n=0;n<this.clusters.length;n++){var o=this.clusters[n].key;(l=this.dists[o][this.mins[o]])<e&&(t=o,e=l)}if(e>=this.threshold)return!1;var a=this.index[t],i=this.index[this.mins[t]],r={left:a,right:i,key:a.key,size:a.size+i.size};this.clusters[a.index]=r,this.clusters.splice(i.index,1),this.index[a.key]=r;for(n=0;n<this.clusters.length;n++){var l,s=this.clusters[n];a.key==s.key?l=1/0:"single"==this.linkage?(l=this.dists[a.key][s.key],this.dists[a.key][s.key]>this.dists[i.key][s.key]&&(l=this.dists[i.key][s.key])):"complete"==this.linkage?(l=this.dists[a.key][s.key],this.dists[a.key][s.key]<this.dists[i.key][s.key]&&(l=this.dists[i.key][s.key])):l="average"==this.linkage?(this.dists[a.key][s.key]*a.size+this.dists[i.key][s.key]*i.size)/(a.size+i.size):this.distance(s.value,a.value),this.dists[a.key][s.key]=this.dists[s.key][a.key]=l}for(n=0;n<this.clusters.length;n++){var c=this.clusters[n].key;if(this.mins[c]==a.key||this.mins[c]==i.key){e=c;for(var u=0;u<this.clusters.length;u++){var d=this.clusters[u].key;this.dists[c][d]<this.dists[c][e]&&(e=d)}this.mins[c]=e}this.clusters[n].index=n}return delete a.key,delete i.key,delete a.index,delete i.index,!0}};t.hcluster=function(t,n,o,a,i,r){var l=new e(n,o=o||"average",a).cluster(t,i,r);return void 0===a?l[0]:l}}(this.hcluster={}),(GENEMAP=GENEMAP||{}).MenuBar=function(t){var e,n={onNetworkBtnClick:$.noop,onFitBtnClick:$.noop,onTagBtnClick:$.noop,onLabelBtnClick:$.noop,onQtlBtnClick:$.noop,onResetBtnClick:$.noop,onSetNumberPerRowClick:$.noop,onExportBtnClick:$.noop,onExportAllBtnClick:$.noop,onExpandBtnClick:$.noop,maxSnpPValueProperty:$.noop,nGenesToDisplayProperty:$.noop,annotationLabelSizeProperty:$.noop,initialMaxGenes:200,initialNPerRow:10},o=_.merge({},n,t),a=function(){$(this).hasClass("disabled")||o.onNetworkBtnClick()},i=function(){$(this).hasClass("disabled")||o.onTagBtnClick()},r=function(){$(this).hasClass("disabled")||o.onFitBtnClick()},l=function(){$(this).hasClass("disabled")||($("#select-label-btn").selectpicker("val","Auto labels").change(),$("#select-qtl-btn").selectpicker("val","All QTLs").change(),o.onResetBtnClick())},s=function(){o.onExpandBtnClick()},c=function(t,e,n,o,a){var i="select-"+e,r=t.selectAll("select").data([null]);r.enter().append("select").attr({id:i,name:i,class:"menu-dropdown"}),r.selectAll("option").data(n).enter().append("option").attr("data-token",(function(t){return t[1]})).text((function(t){return t[0]}));var l=$("#"+i).selectpicker({width:"130px"});l.selectpicker("val",a),l.selectpicker("refresh"),l.on("change",(function(t){var e=l.find("option:selected").data().token;o(e)}))};function u(t){t.each((function(t){e=this,function(){var t=d3.select(e).selectAll(".genemap-menu").data([null]);t.enter().append("div").classed("genemap-menu",!0);var n=t.selectAll("span").data([["network-btn","expand-btn","reset-btn"],["label-btn","ngenes-dropdown"],["fit-btn","export-btn","advanced-toggle","help-btn"]]).enter().append("span").classed("menu-block",!0).selectAll("span").data((function(t,e){return t}));n.enter().append("span"),n.attr({class:function(t){return t}}),t.select(".network-btn").attr("title","Launch network view").on("click",a),t.select(".tag-btn").on("click",i);var u=t.select(".label-btn");c(u,"label-btn",[["Auto labels","auto"],["Checked labels","show"],["No labels","hide"]],o.onLabelBtnClick,"Auto labels"),t.select(".fit-btn").attr("title","Reset pan and zoom").on("click",r),t.select(".reset-btn").attr("title","Reset selections").on("click",l);var d=t.select(".ngenes-dropdown");d.text(""),c(d,"ngenes-dropdown",[["50 genes",50],["100 genes",100],["200 genes",200],["500 genes",500],["1000 genes",1e3]],o.nGenesToDisplayProperty,o.nGenesToDisplayProperty()+" genes"),o.nGenesToDisplayProperty.addListener((function(t){$("#select-ngenes-dropdown").selectpicker("val",[t+" genes",t])})),t.select(".export-btn").attr({title:"Export view to png"}).on("click",o.onExportBtnClick),t.select(".expand-btn").attr("title","Toggle full screen").on("click",s),t.select(".advanced-toggle").attr("title","Show advanced options").on("click",(function(){$(".genemap-advanced-menu").modalPopover("toggle")})),t.select(".help-btn").attr({title:"help"}).on("click",(function(){window.open("https://github.com/francis-newson-tessella/QTLNetMiner/tree/QTLNM-47-MVE/common/client/src/main/webapp/html/GeneMap/docs","_blank")}));var h=d3.select(e).selectAll(".genemap-advanced-menu").data([null]);popoverDiv=h.enter().append("div").classed("genemap-advanced-menu",!0).classed("popover",!0),popoverDiv.append("div").attr({class:"arrow"}),popoverHeading=popoverDiv.append("h3").attr({class:"popover-title"}).text("Advanced options"),popoverHeading.append("button").attr({class:"close"}).on("click",(function(){$(".genemap-advanced-menu").modalPopover("toggle")})).append("span").html("&times"),popoverDiv.append("div").classed("popover-content",!0),h.select(".popover-content").selectAll("div").data(["qtl-btn","nperrow-spinner","max-snp-pvalue","labelsize","export-all-btn"]).enter().append("div").attr("class",(function(t){return t}));var p=h.select(".qtl-btn");c(p,"qtl-btn",[["All QTLs","all"],["Checked QTLs","selected"],["No QTLs","none"]],o.onQtlBtnClick,"All QTLs");var m=h.select(".max-snp-pvalue").selectAll("form").data([""]).enter().append("form").classed("bootstrap",!0).attr({id:"snp-pvalue-form",class:"bootstrap form-inline"});m.append("label").attr({id:"max-snp-pvalue-text",for:"max-snp-pvalue-input"}).html("Max SNP p-value:&nbsp"),m.append("input").attr({class:"form-control",id:"max-snp-pvalue-input",type:"text",value:o.maxSnpPValueProperty()}),m.append("button").attr({class:"btn btn-default",type:"submit"}).text("Set"),$("#snp-pvalue-form").submit((function(t){o.maxSnpPValueProperty($("#max-snp-pvalue-input").val()),t.preventDefault()})),o.maxSnpPValueProperty.addListener((function(t){$("#max-snp-pvalue-input").val(t)}));var f=h.select(".nperrow-spinner"),g=f.selectAll("input").data(["nPerRowSpinner"]).enter();g.append("span").append("label").classed("bootstrap",!0).attr({for:function(t){return t}}).html("Num per row:&nbsp;"),g.append("span").append("input").attr({id:function(t){return t},type:"text",value:o.initialNPerRow,name:function(t){return t}});var y=f.select("input");$(y).TouchSpin({min:1,max:20,step:1}),d3.select(".nperrow-spinner").select(".input-group").style({width:"8em",display:"inline-table"}),$("#nPerRowSpinner").on("change",(function(t){o.onSetNumberPerRowClick($("#nPerRowSpinner").val())})),h.select(".export-all-btn").attr({title:"export all to png"}).on("click",o.onExportAllBtnClick),h.select(".labelsize").selectAll("span").data(["labelsize-label","labelsize-dropdown"]).enter().append("span").attr({class:function(t){return t}}),h.select(".labelsize-label").classed("bootstrap",!0),h.select(".labelsize-label").selectAll("label").data([""]).enter().append("label").text("Label size:");var b=h.select(".labelsize-dropdown");b.text(""),c(b,"labelsize-dropdown",[["10",10],["15",15],["20",20],["25",25]],o.annotationLabelSizeProperty,o.annotationLabelSizeProperty()),o.annotationLabelSizeProperty.addListener((function(t){$("#select-labelsize-dropdown").selectpicker("val",[t,t])})),$(".genemap-advanced-menu").modalPopover({target:$(".advanced-toggle"),parent:$(".advanced-toggle"),"modal-position":"relative",placement:"bottom",boundingSize:o.drawing})}()}))}return u.onNetworkBtnClick=function(t){return arguments.length?(o.onNetworkBtnClick=t,u):o.onNetworkBtnClick},u.onTagBtnClick=function(t){return arguments.length?(o.onTagBtnClick=t,u):o.onTagBtnClick},u.onLabelBtnClick=function(t){return arguments.length?(o.onLabelBtnClick=t,u):o.onLabelBtnClick},u.onQtlBtnClick=function(t){return arguments.length?(o.onQtlBtnClick=t,u):o.onQtlBtnClick},u.onFitBtnClick=function(t){return arguments.length?(o.onFitBtnClick=t,u):o.onFitBtnClick},u.onResetBtnClick=function(t){return arguments.length?(o.onResetBtnClick=t,u):o.onResetBtnClick},u.onSetNumberPerRowClick=function(t){return arguments.length?(o.onSetNumberPerRowClick=t,u):o.onSetNumberPerRowClick},u.initialMaxGenes=function(t){return arguments.length?(o.initialMaxGenes=t,u):o.initialMaxGenes},u.initialNPerRow=function(t){return arguments.length?(o.initialNPerRow=t,u):o.initialNPerRow},u.onExportBtnClick=function(t){return arguments.length?(o.onExportBtnClick=t,u):o.onExportBtnClick},u.onExportAllBtnClick=function(t){return arguments.length?(o.onExportAllBtnClick=t,u):o.onExportAllBtnClick},u.onExpandBtnClick=function(t){return arguments.length?(o.onExpandBtnClick=t,u):o.onExpandBtnClick},u.maxSnpPValueProperty=function(t){return arguments.length?(o.maxSnpPValueProperty=t,u):o.maxSnpPValueProperty},u.nGenesToDisplayProperty=function(t){return arguments.length?(o.nGenesToDisplayProperty=t,u):o.nGenesToDisplayProperty},u.annotationLabelSizeProperty=function(t){return arguments.length?(o.annotationLabelSizeProperty=t,u):o.annotationLabelSizeProperty},u.setTabButtonState=function(t){var n=d3.select(e).select(".tag-btn");"show"===t?(n.classed("show-label",!0),n.classed("hide-label",!1),n.classed("auto-label",!1),n.classed("manual-label",!1),n.attr("title","Show Labels")):"hide"===t?(n.classed("show-label",!1),n.classed("hide-label",!0),n.classed("auto-label",!1),n.classed("manual-label",!1),n.attr("title","Hide Labels")):"manual"===t?(n.classed("show-label",!1),n.classed("hide-label",!1),n.classed("auto-label",!1),n.classed("manual-label",!0),n.attr("title","Manual Labels")):(n.classed("show-label",!1),n.classed("hide-label",!1),n.classed("auto-label",!0),n.classed("manual-label",!1),n.attr("title","Automatic Labels"))},u.getTagButtonState=function(){var t=d3.select(e).select(".tag-btn");return t.classed("show-label")?"show":t.classed("hide-label")?"hide":t.classed("auto-label")?"auto":"manual"},u.setFitButtonEnabled=function(t){d3.select(e).select(".fit-btn").classed("disabled",!t)},u.setNetworkButtonEnabled=function(t){d3.select(e).select(".network-btn").classed("disabled",!t)},u},(GENEMAP=GENEMAP||{}).QTLAnnotationCombiner=function(){return{combineSimilarQTLAnnotations:function(t){var e=[],n={};return t.forEach((function(t){var e=t.start+"-"+t.end;n.hasOwnProperty(e)||(n[e]=[]),n[e].push(t)})),_.forEach(n,(function(t,n){var o={qtlList:t,count:t.length,start:t[0].start,midpoint:t[0].midpoint,end:t[0].end,type:"qtllist",id:n};e.push(o)})),e}}},(GENEMAP=GENEMAP||{}).QtlAnnotations=function(t){var e={border:!1,onAnnotationSelectFunction:$.noop(),longestChromosome:100,layout:{width:10,height:100,x:0,y:0},bandWidthPercentage:1/8,gapPercentage:1/15,chromosomeWidth:20,annotationMarkerSize:5,annotationLabelSize:5,showAnnotationLabels:!0,maxSnpPValue:1,drawing:null,scale:1},n=_.merge({},e,t),o=function(){return d3.scale.linear().range([0,n.layout.height]).domain([0,n.longestChromosome])},a=function(t,e,i){var r=500,l=o(),s=(n.layout.width,.3*n.layout.chromosomeWidth),c=.4*n.layout.chromosomeWidth;e.layout.qtlNodes.some((function(t){return t.displayLabel}))&&(c*=1.5);var u=.2*i*n.layout.chromosomeWidth,d=function(t){return n.layout.width-t.labelPosition*(c+s)-u},h=function(t){return n.layout.width-t.position*(c+s)-u},p=t.selectAll("g.qtl-annotation").data(e.layout.qtlNodes,(function(t){return t.id})),m=p.enter().append("g").classed("qtl-annotation infobox",!0);m.append("rect").classed("qtl-hoverbox",!0);var f=m.append("rect").classed("qtl-selector infobox",!0),g={},y={};p.exit().select("rect").each((function(t){g[t.index]=_.pick(this,["x","y","width","height"]),g[t.index].midpoint=t.midpoint,g[t.index].position=t.position})),f.each((function(t){y[t.index]=_.pick(this,["x","y","width","height"]),y[t.index].midpoint=t.midpoint,y[t.index].position=t.position}));var b=function(t,e,n,o){return _.has(t,e)?t[e][n].animVal.value:o};f.attr({x:function(t){return b(g,t.parentIndex,"x",h(t))},y:function(t){return b(g,t.parentIndex,"y",l(t.start))},width:s,height:function(t){return b(g,t.parentIndex,"height",l(t.end)-l(t.start))}}),p.attr("id",(function(t){return"feature_"+t.id})),p.select("rect.qtl-hoverbox").attr({x:function(t){return h(t)},y:function(t){return l(t.start)},width:function(t){return t.position*(c+s)+n.chromosomeWidth+u},height:function(t){return l(t.end)-l(t.start)},fill:function(t){return t.color},visibility:function(t){return t.hover?"visible":"hidden"}}),p.select("rect.qtl-selector").transition().duration(r).attr({x:h,y:function(t){return l(t.start)},width:s,height:function(t){return l(t.end)-l(t.start)}}),p.select("rect.qtl-selector").style({fill:function(t){return t.color}}),debugQtlLableBoxes=!1,debugQtlLableBoxes&&p.select("rect.test").attr({x:function(t){return t.displayLabel?d(t):0},y:function(t){return t.displayLabel?l(t.midpoint)-.6*t.screenLabel.length*n.annotationLabelSize/2:0},width:function(t){return s},height:function(t){return t.displayLabel?.6*t.screenLabel.length*n.annotationLabelSize:0},fill:function(t){return"pink"}}),p.exit().select("rect").transition().duration(r).attr({x:function(t){return b(y,t.parentIndex,"x",h(t))},y:function(t){return b(y,t.parentIndex,"y",l(t.start))},width:s,height:function(t){return b(y,t.parentIndex,"height",l(t.end)-l(t.start))}}).remove(),p.exit().remove();var v=function(t){return l(t.midpoint)},x=m.append("g").classed("qtl-count-group",!0),w=p.select("g.qtl-count-group").selectAll("g.qtllist").data((function(t){return"qtllist"==t.type?[t]:[]}),(function(t){return"label_"+t.id})),C=w.enter().append("g").classed("qtllist",!0);C.append("circle").classed("qtl-count",!0),C.append("text").classed("qtl-count",!0),x.each((function(t){if(_.has(y,t.index))if(_.has(g,t.parentIndex)){oldNode=g[t.parentIndex];var e=n.layout.width-oldNode.position*(c+s),o=l(oldNode.midpoint);d3.select(this).attr({transform:"translate("+(e+.5*s)+","+o+")"})}else d3.select(this).attr({transform:function(t){return t?"translate("+(h(t)+.5*s)+","+v(t)+")":"translate(0,0)"}})})),p.select("g.qtl-count-group").transition().duration(r).attr({transform:function(t){return t?"translate("+(h(t)+.5*s)+","+v(t)+")":"translate(0,0)"}}),p.select("circle.qtl-count").attr({cx:0,cy:0,r:s+"px"}).style({visibility:"visible",fill:function(t){return t.color}}).attr({id:function(t){return t.id}});var L=Math.min(Math.max(10/n.scale,s),14/n.scale);p.select("text.qtl-count").attr({x:0,y:0,dy:"0.3em","text-anchor":"middle"}).style({fill:"white","font-size":L+"px",visibility:L<2*s?"visible":"hidden"}).text((function(t){return t.count})),w.exit().remove(),m.append("g").classed("qtl-label-group",!0);var P=p.select("g.qtl-label-group").selectAll("g.qtl").data((function(t){return t.displayLabel?[t]:[]}),(function(t){return"label_"+t.id}));P.exit().remove(),P.transition().duration(r).attr({transform:function(t){return"translate("+(d(t)+.5*s)+","+v(t)+")"}}),P.enter().append("g").classed("qtl",!0).attr({transform:function(t){return"translate("+(d(t)+.5*s)+","+v(t)+")"}}).append("text").classed("qtl-label",!0),p.select("text.qtl-label").attr({x:0,y:0,dy:"0.3em","text-anchor":"middle"}).style({"font-size":function(t){return t.fontSize+"px"}}).attr({transform:"rotate(270)",visibility:function(t){return"show"===t.displayLabel?"visible":"hide"!==t.displayLabel||"hidden"}}).text((function(t){return t.screenLabel}));var k=function(n){n.on("mouseenter",(function(n){n.hover=!0,a(t,e,i)})).on("mouseout",(function(n){n.hover=!1,a(t,e,i)})).on("click",(function(n){n.hover=!n.hover,a(t,e,i)}))};k(p.select("rect.qtl-selector")),k(p.select("circle.qtl-count")),k(p.select("text.qtl-count")),p.on("contextmenu",(function(t){log.trace("Gene Annotation Context Menu");var e=d3.select("#clusterPopover");e.attr("class","popover");var o=e.select(".popover-title");o.selectAll("*").remove(),o.text(""),o.text("Chromosome "+t.chromosome+": "+t.start+"-"+t.end),$.fn.redraw=function(){return $(this).each((function(){this.offsetHeight}))},(a=e.select(".popover-content")).selectAll("*").remove(),a.text("");var a=e.select(".popover-content").selectAll("p").data("qtllist"==t.type?t.qtlList:[t]);a.enter().append("p").classed("popover-annotation",!0);var i=a.append("div").attr({class:"checkbox"}).append("label");i.append("input").attr({type:"checkbox",value:""}).property("checked",(function(t){return t.selected})).on("click",(function(t){t.selected=!t.selected,a.classed("selected",(function(t){return t.selected})),n.onAnnotationSelectFunction()})),i.append("a").attr({href:function(t){return t.link},target:"_blank"}).text((function(t){return t.label})),a.classed("selected",(function(t){return t.selected})),$clusterPopover=$("#clusterPopover"),$clusterPopover.modalPopover({target:$(this),$parent:$(this).find("rect"),"modal-position":"body",placement:"left",boundingSize:n.drawing}),$clusterPopover.modalPopover("show"),$clusterPopover.on("mousedown mousewheel",(function(t){log.info("popover click"),t.stopPropagation()}))}))};function i(t){t.each((function(t){var e,i=t.annotations.snps.filter((function(t){return!(t.pvalue>n.maxSnpPValue)})),r=function(t){var e=new Set;return t.map((function(t){e.add(t.trait)})),Array.from(e).sort()}(i),l=d3.select(this).selectAll(".qtl-annotations").data([t]);l.enter().append("g").attr("class","qtl-annotations"),l.attr({transform:"translate("+n.layout.x+","+n.layout.y+")"}),a(l,t,r.length),n.border&&((e=l).select("rect.border").empty()&&e.append("rect").classed("border",!0),e.select("rect.border").attr({width:n.layout.width,height:n.layout.height})),l.exit().remove();var s=d3.select(this).selectAll(".snp-annotations").data([t]);s.enter().append("g").attr("class","snp-annotations"),s.attr({transform:"translate("+n.layout.x+","+n.layout.y+")"}),function(t,e,a,i){var r={};i.map((function(t,e){r[t]=e}));var l=o(),s=t.selectAll("rect.snp-annotation").data(a,(function(t){return t.id})),c=function(t){return n.layout.width-.2*n.layout.chromosomeWidth*(1+r[t.trait])},u=function(t){return l(t.midpoint)-.5*Math.max(4/n.scale,l(10))},d=Math.max(4/n.scale,l(10)),h=.2*n.layout.chromosomeWidth;s.attr({x:c,y:u,width:h,height:d}),s.enter().append("rect").attr({fill:function(t){return t.color},opacity:function(t){return t.importance},class:"snp-annotation",x:c,y:u,width:h,height:d}),s.exit().remove(),s.on("contextmenu",(function(t){log.trace("SNP Context Menu");var o=d3.select("#clusterPopover");o.attr("class","popover");var a=o.select(".popover-title");a.selectAll("*").remove(),a.text("");var i=o.select(".popover-content");i.selectAll("*").remove(),i.text(""),a.append("span").text("SNP: "),a.append("a").attr("href",t.link).text(t.label),i.selectAll("p").data([["Chromsome "+e.number,t.midpoint],["p-value",Number(t.pvalue).toExponential()],["Trait",t.trait]]).enter().append("p").classed("popover-annotation",!0).text((function(t){return t[0]+": "+t[1]})),$clusterPopover=$("#clusterPopover"),$clusterPopover.modalPopover({target:$(this),$parent:$(this),"modal-position":"body",placement:"left",boundingSize:n.drawing}),$clusterPopover.modalPopover("show"),$clusterPopover.on("mousedown mousewheel",(function(t){log.info("popover click"),t.stopPropagation()}))}))}(s,t,i,r),s.exit().remove()}))}return i.onAnnotationSelectFunction=function(t){return arguments.length?(n.onAnnotationSelectFunction=t,i):n.onAnnotationSelectFunction},i.layout=function(t){return arguments.length?(n.layout=t,i):n.layout},i.drawing=function(t){return arguments.length?(n.drawing=t,i):n.drawing},i.longestChromosome=function(t){return arguments.length?(n.longestChromosome=t,i):n.longestChromosome},i.chromosomeWidth=function(t){return arguments.length?(n.chromosomeWidth=t,i):n.chromosomeWidth},i.annotationLabelSize=function(t){return arguments.length?(n.annotationLabelSize=t,i):n.annotationLabelSize},i.annotationMarkerSize=function(t){return arguments.length?(n.annotationMarkerSize=t,i):n.annotationMarkerSize},i.showAnnotationLabels=function(t){return arguments.length?(n.showAnnotationLabels=t,i):n.showAnnotationLabels},i.maxSnpPValue=function(t){return arguments.length?(n.maxSnpPValue=t,i):n.maxSnpPValue},i.infoBoxManager=function(t){return arguments.length?(n.infoBoxManager=t,i):n.infoBoxManager},i.scale=function(t){return arguments.length?(n.scale=t,i):n.scale},i},(GENEMAP=GENEMAP||{}).QTLAnnotationLayout=function(t){var e=_.merge({},{scale:1,longestChromosome:1e3,showAllQTLs:!0,showSelectedQTLs:!0,showAutoQTLLabels:!0,showSelectedQTLLabels:!0,annotationLabelSize:5},t),n=GENEMAP.QtlPositioner(),o=function(){return d3.scale.linear().range([0,e.layout.height]).domain([0,e.longestChromosome])},a=function(t){return t.map((function(t){var e=s(t),n=e.reduce((function(t,e){return Math.min(t,e.start)}),1/0),o=e.reduce((function(t,e){return Math.max(t,e.end)}),0),a=e.reduce((function(t,e){return t+(t?"|":"")+e.start+"-"+e.end}),""),i=(n+o)/2;if(1==e.length)(r=e[0]).type="qtl",r.index=t.index,r.parentIndex=t.parentIndex;else var r={cluster:t,index:t.index,parentIndex:t.parentIndex,qtlList:e,color:e[0].color,count:e.length,start:n,end:o,midpoint:i,chromosome:e[0].chromosome,type:"qtllist",id:a};return r}))},i=function(t){log.trace("---START---");var i=function(t){var o=[];if(e.showAllQTLs){t.layout.qtlDisplayClusters=t.layout.qtlClusters.slice();for(var i=t.layout.qtlDisplayClusters,r=Math.ceil(Math.floor(e.scale-.1)/2);r--;)i=l(i);for(var s=i.length;(o=a(i),(o=n.sortQTLAnnotations(o)).reduce((function(t,e){return Math.max(t,e.position)}),0)<2)&&s!=(i=l(i)).length;)s=i.length}else e.showSelectedQTLs&&(t.layout.qtlDisplayClusters=t.annotations.qtls.filter((function(t){return t.selected})),o=(i=t.layout.qtlDisplayClusters).map((function(t){return result=t,result.type="qtl",result})));return o}(t);i.forEach((function(t){t.displayLabel=!1}));var r=i.filter((function(t){return"qtl"==t.type}));if(e.showAutoQTLLabels){var s=(i=n.sortQTLAnnotations(i)).reduce((function(t,e){return Math.max(t,e.position)}),0);log.trace("maxPosition",s),r.forEach((function(t){t.label.length>15?t.screenLabel=t.label.substring(0,12)+"...":t.screenLabel=t.label}));var c=(d=14/e.scale)>.6*e.layout.chromosomeWidth;s>3||c?r.forEach((function(t){t.displayLabel=!1})):(!function(t){log.trace("Do label layout");var a=_.groupBy(t,"position");_.forOwn(a,(function(t,a){log.trace("-Col ",a),log.trace("positions ",t.map((function(t){return t.position})));var i=14/e.scale,r=o(),l=(t=n.sortQTLLabels(t,r,i)).reduce((function(t,e){return Math.max(e.labelPosition,t)}),0);log.trace("labelPositions ",t.map((function(t){return t.labelPosition}))),log.trace("maxLabelPosition",l),t.forEach((function(t){t.labelPosition>1?t.displayLabel=!1:(t.displayLabel=!0,t.labelPosition=t.position+.4)})),log.trace("labelPositions",t.map((function(t){return t.labelPosition})))}))}(r),r.forEach((function(t){t.fontSize=d})))}if(e.showSelectedQTLLabels&&!e.showAutoQTLLabels){var u=i.filter((function(t){return t.selected})),d=14/e.scale,h=.3*e.layout.chromosomeWidth;u.forEach((function(t){t.displayLabel=!0,t.screenLabel=t.label,t.fontSize=Math.min(d,2*h)})),(u=n.sortQTLAnnotationsWithLabels(u,o(),e.annotationLabelSize)).forEach((function(t){t.position=t.comboPosition,t.labelPosition=t.comboPosition+.4}))}return i},r=function(t,e){if(t.index=e.index,e.index=e.index+1,t.value)t.unit=!0,t.start=t.value.start,t.end=t.value.end;else{var n=t.left,o=t.right;n.parentIndex=t.index,o.parentIndex=t.index,r(n,e),r(o,e),t.unit=n.unit&&o.unit&&n.start==o.start&&n.end==o.end,t.start=Math.min(t.left.start,t.right.start),t.end=Math.max(t.left.end,t.right.end)}},l=function(t){var e=[];return t.forEach((function(t){if(t.value||t.unit)e.push(t);else{var n=t.left,o=t.right;e.push(n),e.push(o)}})),e},s=function(t){return 1==t.size?[t.value]:s(t.left).concat(s(t.right))};return my={},my.layoutChromosome=function(t){t.layout.qtlNodes=i(t)||t.layout.qtlNodes},my.computeChromosomeClusters=function(t){t.layout.qtlClusters=function(t){var e=hcluster.hcluster(t.annotations.qtls,(function(t,e){if(t.end==e.end&&t.start==e.start)return 0;var n=Math.min(t.end,e.end)-Math.max(t.start,e.start),o=t.end-t.start,a=e.end-e.start,i=n,r=Math.abs(o-a);return Math.max(.1,r-i)}),"single",null),n={index:0};return e.forEach((function(t){r(t,n)})),e}(t)},my},(GENEMAP=GENEMAP||{}).QtlPositioner=function(){var t={positionAnnotations:function(t,e,n,o,a,i){for(var r,l,s=o,c=i,u=a,d=t.sort((function(t,e){return u(t)-u(e)})),h=[],p=0;p<d.length;p++){for(var m=t[p],f=[],g=0;g<h.length;g++){var y=d[h[g]];l=y,s(r=m)<c(l)&&s(l)<c(r)||f.push(h[g])}var b=_.difference(h,f).map((function(t){return e(d[t])})),v=0;for(v=1;v<b.length+1&&-1!==b.indexOf(v);v++);n(m,v),h.push(p)}return d},sortQTLAnnotations:function(e){return t.positionAnnotations(e,(function(t){return t.position}),(function(t,e){t.position=e}),(function(t){return t.start}),(function(t){return t.midpoint}),(function(t){return t.end}))},sortQTLLabels:function(e,n,o){var a=e,i=.6*o;return t.positionAnnotations(a,(function(t){return t.labelPosition}),(function(t,e){t.labelPosition=e}),(function(t){return n(t.midpoint)-i*t.screenLabel.length/2}),(function(t){return t.midpoint}),(function(t){return n(t.midpoint)+i*t.screenLabel.length/2}))},sortQTLAnnotationsWithLabels:function(e,n,o){var a=e;return t.positionAnnotations(a,(function(t){return t.comboPosition}),(function(t,e){t.comboPosition=e}),(function(t){return Math.min(n(t.midpoint)-t.label.length*o/2,t.start)}),(function(t){return t.midpoint}),(function(t){return Math.max(n(t.midpoint)+t.label.length*o/2,t.end)}))}};return t},(GENEMAP=GENEMAP||{}).XmlDataReader=function(){var t=function(t){var e=new Array(8-t.length+1).join("0");return color="#"+e+t.substring(2,t.length),"#00FF00"==color&&(color="#208000"),color},e=function(e){return e.chromosomes.forEach((function(e){e.annotations={allGenes:[],genes:[],qtls:[],snps:[]},e.bands.forEach((function(e){e.color=t(e.color)}))})),e},n=function(n){var o=e(n[0]),a=n[1];a.features.forEach((function(e){e.color=t(e.color)}));a.features.filter((function(t){return"gene"===t.type.toLowerCase()})).forEach((function(t,e){t.globalIndex=e}));return o.chromosomes.forEach((function(t){var e=a.features.filter((function(e){return e.chromosome===t.number})),n=e.filter((function(t){return"gene"===t.type.toLowerCase()})),o=e.filter((function(t){return"qtl"===t.type.toLowerCase()})),i=e.filter((function(t){return"snp"===t.type.toLowerCase()})),r=i.reduce((function(t,e){return Math.min(t,e.pvalue)}),1);i.forEach((function(e,n){e.id=t.number+"_"+n,e.importance=Math.log(e.pvalue)/Math.log(r)})),o.forEach((function(e,n){e.id=t.number+"_"+n,e.selected=!1}));o.reduce((function(t,e){return Math.max(t,e.score)}),0);n.forEach((function(t,e){t.visible=!1,t.hidden=!1,t.displayed=!1,t.importance=function(t){return.4+1/(1+Math.pow(t,3.5))}(e)}));var l=n.slice(0,100);t.annotations={genes:l,allGenes:n,qtls:o,snps:i}})),o};return{readXMLData:function(t,o){var a=GENEMAP.BasemapXmlReader().readBasemapXML(t);if(o){var i=GENEMAP.AnnotationXMLReader().readAnnotationXML(o);return Promise.all([a,i]).then(n,(function(t){return log.error("error while reading XML files: "+t),a.then(e)}))}return a.then(e)},readXMLDataFromRawAnnotationXML:function(t,o){var a=GENEMAP.BasemapXmlReader().readBasemapXML(t);if(o){var i=GENEMAP.AnnotationXMLReader().readAnnotationXMLFromRawXML(o);return Promise.all([a,i]).then(n,(function(t){return log.error("error while reading XML strings: "+t),a.then(e)}))}return a.then(e)}}};